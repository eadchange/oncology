# 抗肿瘤药物临床试验数据库设计说明

## 1. 设计理念

### 1.1 标准化原则
本数据库设计严格遵循以下标准：
- **CDISC SDTM标准**: 临床研究数据制表模型，确保数据的标准化和互操作性
- **ADaM标准**: 分析数据模型，支持统计分析
- **北京市地方标准 DB11/T 2275.1-2024**: 恶性肿瘤临床研究数据集通则
- **国际医学标准**: ICD-10、MedDRA、ATC等标准术语

### 1.2 设计目标
1. **数据完整性**: 确保所有必要数据的完整记录
2. **数据一致性**: 通过标准化和约束保证数据一致性
3. **查询效率**: 优化索引设计，支持高效查询
4. **可扩展性**: 模块化设计，便于未来扩展
5. **安全性**: 敏感数据加密，访问权限控制

## 2. 数据库架构

### 2.1 数据表分类

```
抗肿瘤药物临床试验数据库
├── 用户和权限管理
│   ├── users (用户表)
│   ├── admins (管理员表)
│   └── user_sessions (用户会话表)
│
├── 药物数据（遵循全球已上市抗肿瘤药物数据规范）
│   ├── drugs (药物主表)
│   ├── drug_approvals (药物批准信息)
│   ├── drug_indications (药物适应症)
│   ├── drug_targets (药物靶点)
│   └── drug_interactions (药物相互作用)
│
├── 临床研究数据（遵循CDISC SDTM标准）
│   ├── studies (研究基本信息)
│   ├── study_sponsors (研究申办方)
│   ├── study_sites (研究中心)
│   └── study_results (研究结果)
│
├── 个性化数据
│   ├── favorites (用户收藏)
│   └── search_history (搜索历史)
│
├── 网站管理
│   ├── site_config (网站配置)
│   ├── ad_positions (广告位)
│   ├── advertisements (广告内容)
│   ├── ad_statistics (广告统计)
│   └── operation_logs (操作日志)
│
└── 帮助支持
    ├── help_categories (帮助分类)
    ├── help_articles (帮助文档)
    ├── faqs (常见问题)
    └── feedback (用户反馈)
```

### 2.2 核心数据关系

```
users (1) ----< (N) favorites (N) ----> (1) drugs
users (1) ----< (N) favorites (N) ----> (1) studies
users (1) ----< (N) search_history
users (1) ----< (N) user_sessions

admins (1) ----< (N) operation_logs

drugs (1) ----< (N) drug_approvals
drugs (1) ----< (N) drug_indications
drugs (1) ----< (N) drug_targets
drugs (1) ----< (N) drug_interactions

studies (1) ----< (N) study_sponsors
studies (1) ----< (N) study_sites
studies (1) ----< (N) study_results

help_categories (1) ----< (N) help_articles

ad_positions (1) ----< (N) advertisements
advertisements (1) ----< (N) ad_statistics
```

## 3. 核心数据表详解

### 3.1 用户管理模块

#### 3.1.1 users (用户表)
**设计要点**:
- 支持邮箱和手机号双重登录方式
- 密码使用bcrypt加密存储
- 邮箱和手机号验证状态追踪
- 登录状态通过session_token管理

**字段说明**:
| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | SERIAL | 主键 | PRIMARY KEY |
| username | VARCHAR(50) | 用户名 | UNIQUE, NOT NULL |
| email | VARCHAR(100) | 邮箱 | UNIQUE, NOT NULL |
| phone | VARCHAR(20) | 手机号 | INDEX |
| password_hash | VARCHAR(255) | 密码哈希 | NOT NULL |
| is_verified | BOOLEAN | 验证状态 | DEFAULT FALSE |
| email_verified_at | TIMESTAMP | 邮箱验证时间 | |
| phone_verified_at | TIMESTAMP | 手机验证时间 | |
| verification_code | VARCHAR(6) | 验证码 | |
| code_expires_at | TIMESTAMP | 验证码过期时间 | |
| last_login_at | TIMESTAMP | 最后登录时间 | |
| login_count | INTEGER | 登录次数 | DEFAULT 0 |

#### 3.1.2 user_sessions (用户会话表)
**设计要点**:
- 实现"关闭浏览器后登录态退出"的需求
- 支持多端登录管理
- 会话超时控制

### 3.2 药物数据模块

#### 3.2.1 drugs (药物主表)
**设计要点** (遵循全球已上市抗肿瘤药物数据规范):
- 支持多维度药物信息存储
- 集成多个权威数据库ID（DrugBank、ChEMBL、PubChem等）
- 标准化药物分类和编码

**核心字段**:
- **药物标识**: generic_name (通用名), brand_name (商品名), brand_name_cn (中文商品名)
- **分类编码**: atc_code (ATC分类), drugbank_id, chembl_id, pubchem_id
- **药理信息**: drug_class (药理类别), mechanism (作用机制), molecular_formula (分子式)
- **企业信息**: company (生产企业), company_id (关联企业表)
- **监管信息**: regulatory_info (JSON格式存储各国批准状态)

**数据标准化**:
- 通用名使用国际非专利名(INN)
- 商品名同时存储中英文
- ATC代码遵循WHO标准
- 适应症使用ICD-10编码

#### 3.2.2 drug_approvals (药物批准信息表)
**设计要点**:
- 支持多监管机构批准信息存储
- 记录批准类型（常规、加速、条件性）
- 追踪特殊认定（孤儿药、突破性疗法等）

**批准机构**:
- FDA (美国食品药品监督管理局)
- EMA (欧洲药品管理局)
- NMPA (中国国家药品监督管理局)
- PMDA (日本药品医疗器械局)
- KFDA (韩国食品药品安全部)

#### 3.2.3 drug_indications (药物适应症表)
**设计要点**:
- 标准化适应症术语
- 支持ICD-10、UMLS、MedDRA编码
- 记录治疗线数信息

#### 3.2.4 drug_targets (药物靶点表)
**设计要点**:
- 记录分子水平的药物作用靶点
- 支持UniProt蛋白数据库ID
- 记录作用类型（抑制剂、激动剂等）

### 3.3 临床研究数据模块

#### 3.3.1 studies (研究基本信息表)
**设计要点** (遵循CDISC SDTM标准):
- 支持多注册平台ID（NCT、EUCTR、UTN）
- 标准化研究类型和分期
- 记录研究设计和盲法信息

**核心字段**:
- **研究标识**: nct_id, euctr_id, utn
- **研究标题**: brief_title, official_title
- **研究设计**: study_type, phase, allocation, masking, primary_purpose
- **研究状态**: overall_status, recruitment_status
- **入组信息**: eligibility_criteria, enrollment, healthy_volunteers
- **时间信息**: start_date, completion_date, primary_completion_date
- **结局指标**: primary_outcomes, secondary_outcomes (JSON格式)
- **疾病和干预**: conditions, interventions (JSON格式)

**数据标准化**:
- 研究阶段: Phase 1, Phase 2, Phase 3, Phase 4, N/A
- 研究类型: Interventional, Observational, Expanded Access
- 招募状态: Recruiting, Active, not recruiting, Completed, Terminated, Suspended, Withdrawn

#### 3.3.2 study_sponsors (研究申办方表)
**设计要点**:
- 支持多个申办方和合作方
- 区分申办方类型（企业、学术、政府）
- 标识主要申办方

#### 3.3.3 study_sites (研究中心表)
**设计要点**:
- 记录多中心研究信息
- 支持地理位置筛选
- 记录主要研究者信息

#### 3.3.4 study_results (研究结果表)
**设计要点**:
- 追踪研究结果发布状态
- 记录结果发布日期
- 链接到结果详情页面

### 3.4 个性化数据模块

#### 3.4.1 favorites (收藏表)
**设计要点**:
- 支持收藏药物和研究
- 复合唯一索引防止重复收藏
- 记录收藏时间

#### 3.4.2 search_history (搜索历史表)
**设计要点**:
- 记录用户搜索行为
- 存储搜索筛选条件
- 支持搜索分析和优化

### 3.5 网站管理模块

#### 3.5.1 site_config (网站配置表)
**设计要点**:
- 键值对存储配置信息
- 支持多种数据类型（string, json, boolean, number）
- 可编辑性控制

**核心配置项**:
- 网站基本信息: site_name, site_description, contact_email
- 功能配置: page_size, max_login_attempts, session_timeout
- 开关配置: captcha_enabled, sms_enabled, data_update_interval

#### 3.5.2 ad_positions (广告位配置表)
**设计要点**:
- 预定义广告位置
- 记录尺寸要求
- 支持多种广告类型

**广告位置**:
- header_banner: 页头横幅
- sidebar_top: 侧边栏顶部
- sidebar_bottom: 侧边栏底部
- footer_banner: 页脚横幅
- content_top: 内容区顶部
- content_bottom: 内容区底部

#### 3.5.3 advertisements (广告内容表)
**设计要点**:
- 支持图片、文本、HTML广告
- 投放时间控制
- 展示和点击次数限制
- 优先级管理

#### 3.5.4 ad_statistics (广告统计表)
**设计要点**:
- 按日期统计展示和点击
- 支持效果分析
- 为后台报表提供数据

#### 3.5.5 operation_logs (操作日志表)
**设计要点**:
- 记录所有重要操作
- 包含用户、IP、请求信息
- 支持审计和安全追踪

### 3.6 数据抓取模块

#### 3.6.1 scraping_logs (数据抓取日志表)
**设计要点**:
- 记录各数据源抓取状态
- 统计处理数据量
- 记录错误信息便于调试

**数据源**:
- fda: FDA数据
- nmpa: NMPA数据
- clinicaltrials: ClinicalTrials.gov数据
- ema: EMA数据
- pubmed: PubMed文献数据

### 3.7 帮助支持模块

#### 3.7.1 help_categories (帮助文档分类表)
**设计要点**:
- 支持多级分类
- 排序控制
- 分类描述

#### 3.7.2 help_articles (帮助文档表)
**设计要点**:
- 富文本内容存储
- SEO友好的URL slug
- 标签和关键词支持
- 发布状态控制

#### 3.7.3 faqs (常见问题表)
**设计要点**:
- 问答形式
- 分类和排序
- 访问统计

#### 3.7.4 feedback (用户反馈表)
**设计要点**:
- 支持多种反馈类型
- 处理状态追踪
- 管理员回复功能

## 4. 索引设计策略

### 4.1 索引设计原则
1. **高频查询字段**: 为经常作为查询条件的字段创建索引
2. **外键字段**: 所有外键字段都创建索引
3. **唯一性约束**: 需要唯一性的字段创建唯一索引
4. **全文搜索**: 文本内容创建全文搜索索引

### 4.2 核心索引

#### 4.2.1 用户相关索引
```sql
-- 登录查询优化
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_phone ON users(phone);
CREATE INDEX idx_users_username ON users(username);

-- 验证状态查询
CREATE INDEX idx_users_verified ON users(is_verified);
```

#### 4.2.2 药物相关索引
```sql
-- 药物搜索优化
CREATE INDEX idx_drugs_generic ON drugs(generic_name);
CREATE INDEX idx_drugs_brand ON drugs(brand_name);
CREATE INDEX idx_drugs_brand_cn ON drugs(brand_name_cn);
CREATE INDEX idx_drugs_company ON drugs(company);
CREATE INDEX idx_drugs_category ON drugs(category);
CREATE INDEX idx_drugs_drug_class ON drugs(drug_class);

-- 外部ID查询
CREATE INDEX idx_drugs_drugbank ON drugs(drugbank_id);
CREATE INDEX idx_drugs_atc ON drugs(atc_code);
```

#### 4.2.3 研究相关索引
```sql
-- 研究查询优化
CREATE INDEX idx_studies_nct ON studies(nct_id);
CREATE INDEX idx_studies_status ON studies(overall_status);
CREATE INDEX idx_studies_phase ON studies(phase);
CREATE INDEX idx_studies_type ON studies(study_type);
CREATE INDEX idx_studies_sponsor ON studies(sponsor);

-- 时间查询优化
CREATE INDEX idx_studies_start_date ON studies(start_date);
CREATE INDEX idx_studies_completion_date ON studies(completion_date);
```

#### 4.2.4 全文搜索索引
```sql
-- 药物全文搜索
CREATE INDEX idx_drugs_fulltext ON drugs 
USING gin(to_tsvector('english', 
  coalesce(generic_name, '') || ' ' || 
  coalesce(brand_name, '') || ' ' || 
  coalesce(brand_name_cn, '') || ' ' || 
  coalesce(drug_class, '') || ' ' || 
  coalesce(mechanism, '') || ' ' || 
  coalesce(company, '')
));

-- 研究全文搜索
CREATE INDEX idx_studies_fulltext ON studies 
USING gin(to_tsvector('english', 
  coalesce(brief_title, '') || ' ' || 
  coalesce(official_title, '') || ' ' || 
  coalesce(brief_summary, '') || ' ' || 
  coalesce(conditions::text, '')
));
```

## 5. 数据完整性约束

### 5.1 主键约束
- 每个表都有自增主键id
- 业务唯一字段创建唯一索引

### 5.2 外键约束
- 维护表间关系完整性
- 级联删除设置（ON DELETE CASCADE）
- 级联更新设置（ON UPDATE CASCADE）

### 5.3 检查约束
```sql
-- 邮箱格式验证
CHECK (email ~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$')

-- 手机号格式验证
CHECK (phone ~* '^\+?[0-9]{7,15}$')

-- 状态值验证
CHECK (overall_status IN ('Recruiting', 'Active, not recruiting', 
    'Completed', 'Terminated', 'Suspended', 'Withdrawn'))
```

### 5.4 非空约束
- 核心字段设置NOT NULL
- 可选字段允许NULL

## 6. 性能优化策略

### 6.1 查询优化
1. **索引优化**: 合理创建和使用索引
2. **查询优化**: 避免全表扫描，使用索引查询
3. **分页优化**: 使用基于游标的分页
4. **连接优化**: 减少不必要的JOIN操作

### 6.2 缓存策略
1. **Redis缓存**: 热点数据缓存
2. **查询缓存**: 复杂查询结果缓存
3. **页面缓存**: 静态页面缓存

### 6.3 分区策略
1. **时间分区**: 按年份分区历史数据
2. **功能分区**: 按功能模块分区存储

## 7. 数据安全设计

### 7.1 数据加密
1. **密码加密**: bcrypt哈希存储
2. **敏感数据**: 敏感字段加密存储
3. **传输加密**: HTTPS传输

### 7.2 访问控制
1. **用户认证**: JWT Token认证
2. **权限控制**: RBAC权限模型
3. **审计日志**: 操作日志记录

### 7.3 数据备份
1. **定期备份**: 每日全量备份
2. **增量备份**: 每小时增量备份
3. **异地备份**: 异地存储备份

## 8. 数据标准化

### 8.1 药物名称标准化
- 通用名: 使用INN (International Nonproprietary Name)
- 商品名: 存储中英文商品名
- 企业名称: 标准化企业名称

### 8.2 疾病术语标准化
- 适应症: 使用ICD-10编码
- 不良反应: 使用MedDRA术语
- 实验室检查: 使用LOINC编码

### 8.3 编码标准化
- ATC代码: WHO药物分类
- NCT编号: ClinicalTrials.gov标准
- 机构标识: 使用GRID或ROR ID

## 9. 扩展性设计

### 9.1 模块化设计
- 功能模块独立
- 接口标准化
- 低耦合高内聚

### 9.2 字段扩展
- JSONB字段存储扩展信息
- 预留扩展字段
- 版本控制机制

### 9.3 分片策略
- 水平分片: 按数据量分片
- 垂直分片: 按功能分片

## 10. 数据质量管理

### 10.1 数据验证
- 输入数据验证
- 数据格式验证
- 业务规则验证

### 10.2 数据清洗
- 去重处理
- 格式统一
- 异常值处理

### 10.3 数据监控
- 数据完整性监控
- 数据一致性检查
- 数据质量报告

## 11. 数据库维护

### 11.1 日常维护
- 索引重建
- 统计信息更新
- 日志清理

### 11.2 定期维护
- 数据归档
- 性能调优
- 安全检查

### 11.3 应急处理
- 数据恢复
- 故障排查
- 性能问题处理

---

**文档版本**: v1.0  
**创建日期**: 2026-01-12  
**最后更新**: 2026-01-12
